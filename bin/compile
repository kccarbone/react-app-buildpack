#!/bin/sh

# Fail immediately on non-zero exit code
set -eu
unset GIT_DIR

echo "Folder structure verified."

# Directories
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
PACK_DIR=`cd $(dirname $0); cd ..; pwd`
TEMP_DIR=$(mktemp -t buildpackXXXXXX)
rm -rf $TEMP_DIR

echo "=====> Downloading Node.js buildpack"
echo $TEMP_DIR
echo $(which git)

git clone https://github.com/heroku/heroku-buildpack-nodejs.git $TEMP_DIR 
cd $TEMP_DIR
echo $(ls)
chmod -f +x $TEMP_DIR/bin/{detect,compile,release} || true

echo "=====> Installing"

$TEMP_DIR/bin/compile $BUILD_DIR $CACHE_DIR $ENV_DIR

exit 1